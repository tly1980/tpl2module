"use strict"

tpl2module = require '..'
path = require 'path'
ArgumentParser = require('argparse').ArgumentParser
mustache = require 'mustache'
fs = require 'fs'
#seq = require 'seq'

parser = new ArgumentParser({
  version: tpl2module.version.version,
  addHelp: true,
  description: 'A command line tool turn templates into JS or JSON'
})

parser.addArgument ['--src', '-s'], {
    action: 'store',
    dest:   'src_folder',
    help:   'the folder to parse',
    defaultValue: null
}

parser.addArgument [ '--json' ], { 
    action: 'appendConst',
    dest:   'json',
    help:   'Compile the template into JSON file.',
    constant: 'storeTrue'
}

parser.addArgument [ '-a', '--amdjs' ], { 
    help: 'Compile the template into JS file (in AMDJS/RequiredJS format).',
    action: 'storeTrue',
    defaultValue: false,
}

parser.addArgument ['-o', '--out'], {
    help: 'where to save the file',
    action: 'store',
    dest: 'out',
    defaultValue: null,
}

parser.addArgument ['-t', '--template'], {
    help: 'Output template. Should be something like "define({{{content}}});"',
    action: 'store',
    dest: 'template',
    defaultValue: null,
}


args = parser.parseArgs()

if not args.src_folder 
    console.log "Please at least specify the src folder of your templates with -s or --src."
    process.exit(1)

if args.template and args.amdjs
    console.log "Option --amdjs and --template are conflicted to each other."
    process.exit(2)


if args.src_folder[0] != '/'
    args.src_folder = path.join(process.cwd(), args.src_folder)

if args.out == null
    args.out = path.basename(args.src_folder)
    args.out = args.out.replace('/', '')

if args.out[0] != '/'
    outpath = args.out
else
    outpath = path.join(process.cwd(), args.out)

tpl2module.compile args.src_folder, (ret)->
    content = JSON.stringify ret
    json_path = outpath + '.json'
    js_path = outpath + '.js'
    
    if args.json
        console.log 'writing to', json_path
        fs.writeFileSync json_path, content

    if args.amdjs
        the_content = '//generated by tpl2js - http://github.com/tly1980/tpl2modue\n'
        the_content += mustache.render "define({{{content}}});", {content: content}
        console.log 'writing (with amdjs format) to', js_path
        fs.writeFileSync js_path, the_content

    if args.template
        the_content = '//generated by tpl2js - http://github.com/tly1980/tpl2modue\n'
        the_content += mustache.render args.template, {content: content}
        console.log 'writing (with customized template ) to', js_path
        fs.writeFileSync js_path, the_content

    
        
    #console.log 'args', args, content, outpath
